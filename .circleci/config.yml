version: 2.1 # use CircleCI 2.0

orbs:
  jira: circleci/jira@1.0.5
  #slack: circleci/slack@4.1.3

jobs:
  build:
    working_directory: /app
    docker:
      - image: docker:latest
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
    steps:
      - checkout
      #- run: git submodule sync
      #- run: git submodule update --init
      - setup_remote_docker
      - run:
          name: Install dependencies
          command: |
            apk add --no-cache \
              make openssl tar gzip curl
      - run:
          name: Build application Docker image
          command: |
            docker build \
              --cache-from=libxcb \
              -t innovanon/libxcb .
      - deploy:
          name: Push application Docker image
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
              docker push innovanon/libxcb
            fi
      - run:
          name: Push upstream (freetype)
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              curl --location --request POST \
                'https://circleci.com/api/v2/project/github/InnovAnon-Inc/freetype/pipeline' \
                --header 'Content-Type: application/json' \
                -u "${FREETYPE_API_TOKEN}:"
            fi

#      - run:
#          name: Push upstream (xorg-libs)
#          command: |
#            if [ "${CIRCLE_BRANCH}" == "master" ]; then
#              curl --location --request POST \
#                'https://circleci.com/api/v2/project/github/InnovAnon-Inc/xorg-libs/pipeline' \
#                --header 'Content-Type: application/json' \
#                -u "${XORG_LIBS_API_TOKEN}:"
#            fi
#

